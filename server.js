const express = require('express');
const TelegramBot = require('node-telegram-bot-api');
require('dotenv').config();

const app = express();
const port = process.env.PORT || 10000;
const appUrl = process.env.APP_URL || 'https://eggbtimerbit.onrender.com';

// Ð”Ð»Ñ webhook Ð½ÑƒÐ¶ÐµÐ½ bodyParser
app.use(express.json());
app.use(express.static('public'));

let bot;
try {
  // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð±Ð¾Ñ‚Ð° Ð±ÐµÐ· ÑÐ²Ð½Ð¾Ð³Ð¾ ÑƒÐºÐ°Ð·Ð°Ð½Ð¸Ñ Ð¿Ð¾Ñ€Ñ‚Ð°
  bot = new TelegramBot(process.env.BOT_TOKEN);

  // Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ webhook
  bot.setWebHook(`${appUrl}/webhook/${process.env.BOT_TOKEN}`);

  app.get('/', (req, res) => {
    res.sendFile(__dirname + '/public/index.html');
  });

  // ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ webhook Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹
  app.post(`/webhook/${process.env.BOT_TOKEN}`, (req, res) => {
    bot.emit('message', req.body);
    res.sendStatus(200);
  });

  // Endpoint Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ð¸ Ñ‚Ð°Ð¹Ð¼ÐµÑ€Ð°
  const eggPhrases = [
    'ðŸ¥š ÐŸÐ¾Ñ€Ð° Ð´Ð¾ÑÑ‚Ð°Ð²Ð°Ñ‚ÑŒ ÑÐ¹Ñ†Ð°! ÐŸÑ€Ð¸ÑÑ‚Ð½Ð¾Ð³Ð¾ Ð°Ð¿Ð¿ÐµÑ‚Ð¸Ñ‚Ð°!',
    'ðŸ³ Ð—Ð°Ð²Ñ‚Ñ€Ð°Ðº Ð³Ð¾Ñ‚Ð¾Ð²! ÐÐµ Ð·Ð°Ð±ÑƒÐ´ÑŒ Ð¿Ð¾ÑÐ¾Ð»Ð¸Ñ‚ÑŒ!',
    'ðŸ˜‹ Ð¡Ð°Ð¼Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ Ð´Ð»Ñ Ð¸Ð´ÐµÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐ¹Ñ†Ð°!',
    'ðŸ¥š Ð’Ñ€ÐµÐ¼Ñ Ð²Ñ‹ÑˆÐ»Ð¾ â€” ÑÐ¹Ñ†Ð° Ð¶Ð´ÑƒÑ‚ Ñ‚ÐµÐ±Ñ!',
    'ðŸ”¥ Ð¯Ð¹Ñ†Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹! ÐÐµ Ð¿ÐµÑ€ÐµÐ´ÐµÑ€Ð¶Ð¸!',
    'â° Ð¢Ð°Ð¹Ð¼ÐµÑ€ ÑÑ€Ð°Ð±Ð¾Ñ‚Ð°Ð», Ð¿Ð¾Ñ€Ð° Ð½Ð°ÑÐ»Ð°Ð¶Ð´Ð°Ñ‚ÑŒÑÑ ÑÐ¹Ñ†Ð°Ð¼Ð¸!',
    'ðŸ¥„ Ð›Ð¾Ð¶ÐºÐ° Ð½Ð°Ð³Ð¾Ñ‚Ð¾Ð²Ðµ? Ð¯Ð¹Ñ†Ð° ÑƒÐ¶Ðµ Ð¶Ð´ÑƒÑ‚!',
    'ðŸ‘Œ Ð˜Ð´ÐµÐ°Ð»ÑŒÐ½Ð°Ñ ÐºÐ¾Ð½ÑÐ¸ÑÑ‚ÐµÐ½Ñ†Ð¸Ñ! ÐŸÑ€Ð¸ÑÑ‚Ð½Ð¾Ð³Ð¾ Ð°Ð¿Ð¿ÐµÑ‚Ð¸Ñ‚Ð°!',
    'ðŸ¥š Ð¯Ð¹Ñ†Ð° ÑÐ²Ð°Ñ€Ð¸Ð»Ð¸ÑÑŒ! ÐœÐ¾Ð¶Ð½Ð¾ Ð·Ð²Ð°Ñ‚ÑŒ Ð²ÑÐµÑ… Ðº ÑÑ‚Ð¾Ð»Ñƒ!',
    'ðŸ˜Ž Ð¯Ð¹Ñ†Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹, ÐºÐ°Ðº Ð¸ Ñ‚Ñ‹ Ðº Ð½Ð¾Ð²Ð¾Ð¼Ñƒ Ð´Ð½ÑŽ!',
    'ðŸ¥š Ð’Ñ€ÐµÐ¼Ñ Ð´Ð»Ñ Ð²ÐºÑƒÑÐ½Ð¾Ð³Ð¾ Ð¿ÐµÑ€ÐµÐºÑƒÑÐ°!',
    'ðŸ½ï¸ Ð¯Ð¹Ñ†Ð° Ð¶Ð´ÑƒÑ‚! ÐÐµ Ð·Ð°Ð±ÑƒÐ´ÑŒ Ñ…Ð»ÐµÐ±ÑƒÑˆÐµÐº!',
    'ðŸ¥š ÐŸÐ¾Ñ€Ð° Ñ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ ÑÐ¹Ñ†Ð° Ð¸ Ð½Ð°ÑÐ»Ð°Ð¶Ð´Ð°Ñ‚ÑŒÑÑ!',
    'ðŸŽ‰ Ð¯Ð¹Ñ†Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹! ÐŸÑƒÑÑ‚ÑŒ Ð´ÐµÐ½ÑŒ Ð±ÑƒÐ´ÐµÑ‚ ÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ð¼!',
    'ðŸ¥š Ð’Ñ€ÐµÐ¼Ñ Ð´Ð»Ñ Ð¸Ð´ÐµÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð·Ð°Ð²Ñ‚Ñ€Ð°ÐºÐ°!',
    'ðŸ¥š Ð¯Ð¹Ñ†Ð° ÑÐ²Ð°Ñ€Ð¸Ð»Ð¸ÑÑŒ! Ð¡Ð°Ð¼Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ Ð¸Ñ… Ð¿Ð¾Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ñ‚ÑŒ!',
    'ðŸ³ ÐŸÑ€Ð¸ÑÑ‚Ð½Ð¾Ð³Ð¾ Ð°Ð¿Ð¿ÐµÑ‚Ð¸Ñ‚Ð°! ÐŸÑƒÑÑ‚ÑŒ ÑÐ¹Ñ†Ð° Ð±ÑƒÐ´ÑƒÑ‚ Ð¸Ð´ÐµÐ°Ð»ÑŒÐ½Ñ‹!',
    'ðŸ¥š Ð¯Ð¹Ñ†Ð° Ð¶Ð´ÑƒÑ‚ Ñ‚ÐµÐ±Ñ! ÐÐµ Ð·Ð°ÑÑ‚Ð°Ð²Ð»ÑÐ¹ Ð¸Ñ… Ð¾ÑÑ‚Ñ‹Ð²Ð°Ñ‚ÑŒ!',
    'ðŸ¥š Ð’Ñ€ÐµÐ¼Ñ Ð²Ñ‹ÑˆÐ»Ð¾! Ð¯Ð¹Ñ†Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹ Ðº Ð¿Ð¾Ð´Ð°Ñ‡Ðµ!',
    'ðŸ¥š Ð¯Ð¹Ñ†Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹! ÐŸÑƒÑÑ‚ÑŒ Ð·Ð°Ð²Ñ‚Ñ€Ð°Ðº Ð±ÑƒÐ´ÐµÑ‚ Ð²ÐºÑƒÑÐ½Ñ‹Ð¼!',
    'ðŸ¥š Ð¡Ð°Ð¼Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ Ð´Ð»Ñ ÑÐ¹Ñ†Ð° Ð²ÑÐ¼ÑÑ‚ÐºÑƒ!',
    'ðŸ¥š Ð¯Ð¹Ñ†Ð° ÑÐ²Ð°Ñ€Ð¸Ð»Ð¸ÑÑŒ! ÐŸÑ€Ð¸ÑÑ‚Ð½Ð¾Ð³Ð¾ Ð°Ð¿Ð¿ÐµÑ‚Ð¸Ñ‚Ð°!',
    'ðŸ¥š Ð’Ñ€ÐµÐ¼Ñ Ð´Ð»Ñ ÑÐ¹Ñ†Ð° Ð² Ð¼ÐµÑˆÐ¾Ñ‡ÐµÐº!',
    'ðŸ¥š Ð¯Ð¹Ñ†Ð° Ð²ÐºÑ€ÑƒÑ‚ÑƒÑŽ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹! ÐœÐ¾Ð¶Ð½Ð¾ Ð½Ð°Ñ‡Ð¸Ð½Ð°Ñ‚ÑŒ!',
    'ðŸ¥š Ð¯Ð¹Ñ†Ð° Ð¶Ð´ÑƒÑ‚ Ñ‚ÐµÐ±Ñ! ÐÐµ Ð·Ð°Ð±ÑƒÐ´ÑŒ Ð¿Ð¾Ð´ÐµÐ»Ð¸Ñ‚ÑŒÑÑ Ñ Ð±Ð»Ð¸Ð·ÐºÐ¸Ð¼Ð¸!',
    'ðŸ¥š Ð—Ð°Ð²Ñ‚Ñ€Ð°Ðº Ð³Ð¾Ñ‚Ð¾Ð²! ÐŸÑƒÑÑ‚ÑŒ Ð´ÐµÐ½ÑŒ Ð±ÑƒÐ´ÐµÑ‚ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¼!',
    'ðŸ¥š Ð¯Ð¹Ñ†Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹! Ð¡Ð°Ð¼Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ñ‚Ð¾ÑÑ‚!',
    'ðŸ¥š Ð¯Ð¹Ñ†Ð° ÑÐ²Ð°Ñ€Ð¸Ð»Ð¸ÑÑŒ! ÐŸÑƒÑÑ‚ÑŒ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸Ðµ Ð±ÑƒÐ´ÐµÑ‚ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð½Ñ‹Ð¼!',
    'ðŸ¥š Ð’Ñ€ÐµÐ¼Ñ Ð´Ð»Ñ Ð¸Ð´ÐµÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐ¹Ñ†Ð°! ÐŸÑ€Ð¸ÑÑ‚Ð½Ð¾Ð³Ð¾ Ð°Ð¿Ð¿ÐµÑ‚Ð¸Ñ‚Ð°!',
    'ðŸ¥š Ð¯Ð¹Ñ†Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹! ÐŸÑƒÑÑ‚ÑŒ Ð´ÐµÐ½ÑŒ Ð½Ð°Ñ‡Ð½Ñ‘Ñ‚ÑÑ Ð²ÐºÑƒÑÐ½Ð¾!',
    'ðŸ¥š Ð¯Ð¹Ñ†Ð° ÑÐ²Ð°Ñ€Ð¸Ð»Ð¸ÑÑŒ! ÐÐ°ÑÐ»Ð°Ð¶Ð´Ð°Ð¹ÑÑ!' 
  ];

  app.post('/timer-complete', (req, res) => {
    const { chat_id } = req.body;
    if (chat_id) {
      const phrase = eggPhrases[Math.floor(Math.random() * eggPhrases.length)];
      bot.sendMessage(chat_id, phrase);
      res.sendStatus(200);
    } else {
      res.sendStatus(400);
    }
  });

  // ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /start
  bot.on('message', (msg) => {
    if (msg.text === '/start') {
      bot.sendMessage(msg.chat.id, 'Welcome to Egg Timer! Use /timer to start.');
    } else if (msg.text === '/timer') {
      bot.sendMessage(msg.chat.id, 'Open the timer:', {
        reply_markup: {
          inline_keyboard: [[
            { text: 'Open Timer', web_app: { url: appUrl } }
          ]]
        }
      });
    }
  });

  app.listen(port, () => {
    console.log(`Server running on port ${port}`);
    console.log(`Webhook URL: ${appUrl}/webhook/${process.env.BOT_TOKEN}`);
  });

} catch (error) {
  console.error('Bot initialization error:', error);
}
